#!/usr/bin/env node

var path = require('path');
var fs = require('fs-extra');
var nodemon = require('nodemon');
var open = require('opn');
var configHandler = require('../libs/config-handler');
var utils = require('../libs/utils');
var JavaServer = require('../libs/java-server');

var opened = false;

if (process.argv[2] === 'init') {
	fs.copy(path.resolve(__dirname, '../example'), '.', function (err) {
		if (err) {
			console.error(err);
			return;
		}
		console.log('Project inited.');
	});
} else {
	var configFile = path.resolve('fds-config.js');
	var config = configHandler(configFile);

	nodemon({
		script: path.resolve(__dirname, '../index.js'),
		watch: [
			config.mockFolder,
			config.routeFile,
			configFile
		],
		ext: 'js json'
	});

	JavaServer.create(config);

	nodemon.on('start', function () {
		if (!opened && config.open) {
			setTimeout(function () {
				var url = 'http://localhost:' + config.port + (config.open.route || '/');
				open(url, {app: config.open.browser});
			}, 500);
		}
		opened = true;
	});

	nodemon.on('restart', function (files) {
		console.log('FE Dev Server is restarting ....');
		if (utils.contains(files, configFile)) {
			config = configHandler(configFile, true);
			JavaServer.restart(config);
		}
	});
}

process.on('exit', JavaServer.close);


